/*
 * jQuery MultiSelect UI Widget 1.13
 * Copyright (c) 2012 Eric Hynds
 *
 * http://www.erichynds.com/jquery/jquery-ui-multiselect-widget/
 *
 * Depends:
 *   - jQuery 1.4.2+
 *   - jQuery UI 1.8 widget factory
 *
 * Optional:
 *   - jQuery UI effects
 *   - jQuery UI position utility
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 */
(function($,u){var v=0;var w=$(document);$.widget("ech.multiselect",{options:{header:true,height:175,minWidth:225,minWidthMenu:225,classes:'',checkAllText:'Check all',uncheckAllText:'Uncheck all',noneSelectedText:'Select options',selectedText:'# selected',selectedList:0,closeIcon:'ui-icon ui-icon-circle-close',show:null,hide:null,autoOpen:false,multiple:true,position:{},appendTo:"body"},_create:function(){var a=this.element.hide();var o=this.options;this.speed=$.fx.speeds._default;this._isOpen=false;this._namespaceID=this.eventNamespace||('multiselect'+v);var b=(this.button=$('<button type="button"><span class="ui-icon ui-icon-triangle-1-s"></span></button>')).addClass('ui-multiselect ui-widget ui-state-default ui-corner-all').addClass(o.classes).attr({'title':a.attr('title'),'aria-haspopup':true,'tabIndex':a.attr('tabIndex')}).insertAfter(a),buttonlabel=(this.buttonlabel=$('<span />')).html(o.noneSelectedText).appendTo(b),menu=(this.menu=$('<div />')).addClass('ui-multiselect-menu ui-widget ui-widget-content ui-corner-all').addClass(o.classes).appendTo($(o.appendTo)),header=(this.header=$('<div />')).addClass('ui-widget-header ui-corner-all ui-multiselect-header ui-helper-clearfix').appendTo(menu),headerLinkContainer=(this.headerLinkContainer=$('<ul />')).addClass('ui-helper-reset').html(function(){if(o.header===true){return'<li><a class="ui-multiselect-all" href="#"><span class="ui-icon ui-icon-check"></span><span>'+o.checkAllText+'</span></a></li><li><a class="ui-multiselect-none" href="#"><span class="ui-icon ui-icon-closethick"></span><span>'+o.uncheckAllText+'</span></a></li>'}else if(typeof o.header==="string"){return'<li>'+o.header+'</li>'}else{return''}}).append('<li class="ui-multiselect-close"><a href="#" class="ui-multiselect-close"><span class="'+o.closeIcon+'"></span></a></li>').appendTo(header),checkboxContainer=(this.checkboxContainer=$('<ul />')).addClass('ui-multiselect-checkboxes ui-helper-reset').appendTo(menu);this._bindEvents();this.refresh(true);if(!o.multiple){menu.addClass('ui-multiselect-single')}v++},_init:function(){if(this.options.header===false){this.header.hide()}if(!this.options.multiple){this.headerLinkContainer.find('.ui-multiselect-all, .ui-multiselect-none').hide()}if(this.options.autoOpen){this.open()}if(this.element.is(':disabled')){this.disable()}},refresh:function(m){var n=this.element;var o=this.options;var p=this.menu;var q=this.checkboxContainer;var r=[];var s="";var t=n.attr('id')||v++;n.find('option').each(function(i){var a=$(this);var b=this.parentNode;var c=this.innerHTML;var d=this.title;var e=this.value;var f='ui-multiselect-'+(this.id||t+'-option-'+i);var g=this.disabled;var h=this.selected;var j=['ui-corner-all'];var k=(g?'ui-multiselect-disabled ':' ')+this.className;var l;if(b.tagName==='OPTGROUP'){l=b.getAttribute('label');if($.inArray(l,r)===-1){s+='<li class="ui-multiselect-optgroup-label '+b.className+'"><a href="#">'+l+'</a></li>';r.push(l)}}if(g){j.push('ui-state-disabled')}if(h&&!o.multiple){j.push('ui-state-active')}s+='<li class="'+k+'">';s+='<label for="'+f+'" title="'+d+'" class="'+j.join(' ')+'">';s+='<input id="'+f+'" name="multiselect_'+t+'" type="'+(o.multiple?"checkbox":"radio")+'" value="'+e+'" title="'+d+'"';if(h){s+=' checked="checked"';s+=' aria-selected="true"'}if(g){s+=' disabled="disabled"';s+=' aria-disabled="true"'}s+=' /><span>'+c+'</span></label></li>'});q.html(s);this.labels=p.find('label');this.inputs=this.labels.children('input');this._setButtonWidth();this._setMenuWidth();this.button[0].defaultValue=this.update();if(!m){this._trigger('refresh')}},update:function(){var o=this.options;var a=this.inputs;var b=a.filter(':checked');var c=b.length;var d;if(c===0){d=o.noneSelectedText}else{if($.isFunction(o.selectedText)){d=o.selectedText.call(this,c,a.length,b.get())}else if(/\d/.test(o.selectedList)&&o.selectedList>0&&c<=o.selectedList){d=b.map(function(){return $(this).next().html()}).get().join(', ')}else{d=o.selectedText.replace('#',c).replace('#',a.length)}}this._setButtonValue(d);return d},_setButtonValue:function(a){this.buttonlabel.text(a)},_bindEvents:function(){var f=this;var g=this.button;function clickHandler(){f[f._isOpen?'close':'open']();return false}g.find('span').bind('click.multiselect',clickHandler);g.bind({click:clickHandler,keypress:function(e){switch(e.which){case 27:case 38:case 37:f.close();break;case 39:case 40:f.open();break}},mouseenter:function(){if(!g.hasClass('ui-state-disabled')){$(this).addClass('ui-state-hover')}},mouseleave:function(){$(this).removeClass('ui-state-hover')},focus:function(){if(!g.hasClass('ui-state-disabled')){$(this).addClass('ui-state-focus')}},blur:function(){$(this).removeClass('ui-state-focus')}});this.header.delegate('a','click.multiselect',function(e){if($(this).hasClass('ui-multiselect-close')){f.close()}else{f[$(this).hasClass('ui-multiselect-all')?'checkAll':'uncheckAll']()}e.preventDefault()});this.menu.delegate('li.ui-multiselect-optgroup-label a','click.multiselect',function(e){e.preventDefault();var a=$(this);var b=a.parent().nextUntil('li.ui-multiselect-optgroup-label').find('input:visible:not(:disabled)');var c=b.get();var d=a.parent().text();if(f._trigger('beforeoptgrouptoggle',e,{inputs:c,label:d})===false){return}f._toggleChecked(b.filter(':checked').length!==b.length,b);f._trigger('optgrouptoggle',e,{inputs:c,label:d,checked:c[0].checked})}).delegate('label','mouseenter.multiselect',function(){if(!$(this).hasClass('ui-state-disabled')){f.labels.removeClass('ui-state-hover');$(this).addClass('ui-state-hover').find('input').focus()}}).delegate('label','keydown.multiselect',function(e){e.preventDefault();switch(e.which){case 9:case 27:f.close();break;case 38:case 40:case 37:case 39:f._traverse(e.which,this);break;case 13:$(this).find('input')[0].click();break}}).delegate('input[type="checkbox"], input[type="radio"]','click.multiselect',function(e){var a=$(this);var b=this.value;var c=this.checked;var d=f.element.find('option');if(this.disabled||f._trigger('click',e,{value:b,text:this.title,checked:c})===false){e.preventDefault();return}a.focus();a.attr('aria-selected',c);d.each(function(){if(this.value===b){this.selected=c}else if(!f.options.multiple){this.selected=false}});if(!f.options.multiple){f.labels.removeClass('ui-state-active');a.closest('label').toggleClass('ui-state-active',c);f.close()}f.element.trigger("change");setTimeout($.proxy(f.update,f),10)});w.bind('mousedown.'+this._namespaceID,function(a){var b=a.target;if(f._isOpen&&b!==f.button[0]&&b!==f.menu[0]&&!$.contains(f.menu[0],b)&&!$.contains(f.button[0],b)){f.close()}});$(this.element[0].form).bind('reset.'+this._namespaceID,function(){setTimeout($.proxy(f.refresh,f),10)})},_setButtonWidth:function(){var a=this.element.outerWidth();var o=this.options;if(/\d/.test(o.minWidth)&&a<o.minWidth){a=o.minWidth}this.button.outerWidth(a)},_setMenuWidth:function(){var m=this.menu;var a=(this.button.outerWidth()<=0)?this.options.minWidth:this.button.outerWidth();if(/\d/.test(this.options.minWidthMenu)&&a<this.options.minWidthMenu){a=this.options.minWidthMenu}m.outerWidth(a)},_traverse:function(a,b){var c=$(b);var d=a===38||a===37;var e=c.parent()[d?'prevAll':'nextAll']('li:not(.ui-multiselect-disabled, .ui-multiselect-optgroup-label)').first();if(!e.length){var f=this.menu.find('ul').last();this.menu.find('label')[d?'last':'first']().trigger('mouseover');f.scrollTop(d?f.height():0)}else{e.find('label').trigger('mouseover')}},_toggleState:function(a,b){return function(){if(!this.disabled){this[a]=b}if(b){this.setAttribute('aria-selected',true)}else{this.removeAttribute('aria-selected')}}},_toggleChecked:function(a,b){var c=(b&&b.length)?b:this.inputs;var d=this;c.each(this._toggleState('checked',a));c.eq(0).focus();this.update();var e=c.map(function(){return this.value}).get();this.element.find('option').each(function(){if(!this.disabled&&$.inArray(this.value,e)>-1){d._toggleState('selected',a).call(this)}});if(c.length){this.element.trigger("change")}},_toggleDisabled:function(a){this.button.attr({'disabled':a,'aria-disabled':a})[a?'addClass':'removeClass']('ui-state-disabled');var b=this.menu.find('input');var c="ech-multiselect-disabled";if(a){b=b.filter(':enabled').data(c,true)}else{b=b.filter(function(){return $.data(this,c)===true}).removeData(c)}b.attr({'disabled':a,'arial-disabled':a}).parent()[a?'addClass':'removeClass']('ui-state-disabled');this.element.attr({'disabled':a,'aria-disabled':a})},open:function(e){var a=this;var b=this.button;var c=this.menu;var d=this.speed;var o=this.options;var f=[];if(this._trigger('beforeopen')===false||b.hasClass('ui-state-disabled')||this._isOpen){return}var g=c.find('ul').last();var h=o.show;if($.isArray(o.show)){h=o.show[0];d=o.show[1]||a.speed}if(h){f=[h,d]}g.scrollTop(0).height(o.height);this.position();$.fn.show.apply(c,f);this.labels.filter(':not(.ui-state-disabled)').eq(0).trigger('mouseover').trigger('mouseenter').find('input').trigger('focus');b.addClass('ui-state-active');this._isOpen=true;this._trigger('open')},close:function(){if(this._trigger('beforeclose')===false){return}var o=this.options;var a=o.hide;var b=this.speed;var c=[];if($.isArray(o.hide)){a=o.hide[0];b=o.hide[1]||this.speed}if(a){c=[a,b]}$.fn.hide.apply(this.menu,c);this.button.removeClass('ui-state-active').trigger('blur').trigger('mouseleave');this._isOpen=false;this._trigger('close')},enable:function(){this._toggleDisabled(false)},disable:function(){this._toggleDisabled(true)},checkAll:function(e){this._toggleChecked(true);this._trigger('checkAll')},uncheckAll:function(){this._toggleChecked(false);this._trigger('uncheckAll')},getChecked:function(){return this.menu.find('input').filter(':checked')},destroy:function(){$.Widget.prototype.destroy.call(this);w.unbind(this._namespaceID);$(this.element[0].form).unbind(this._namespaceID);this.button.remove();this.menu.remove();this.element.show();return this},isOpen:function(){return this._isOpen},widget:function(){return this.menu},getButton:function(){return this.button},position:function(){var o=this.options;if($.ui.position&&!$.isEmptyObject(o.position)){o.position.of=o.position.of||this.button;this.menu.show().position(o.position).hide()}else{var a=this.button.offset();var b=a.top+this.button.outerHeight();if((b+o.height)>$(window).height()){b=b-(this.menu.outerHeight()+this.button.outerHeight());if(b<0)b=0}this.menu.css({top:b,left:a.left})}},_setOption:function(a,b){var c=this.menu;switch(a){case'header':c.find('div.ui-multiselect-header')[b?'show':'hide']();break;case'checkAllText':c.find('a.ui-multiselect-all span').eq(-1).text(b);break;case'uncheckAllText':c.find('a.ui-multiselect-none span').eq(-1).text(b);break;case'height':c.find('ul').last().height(parseInt(b,10));break;case'minWidth':this.options[a]=parseInt(b,10);this._setButtonWidth();this._setMenuWidth();break;case'selectedText':case'selectedList':case'noneSelectedText':this.options[a]=b;this.update();break;case'classes':c.add(this.button).removeClass(this.options.classes).addClass(b);break;case'multiple':c.toggleClass('ui-multiselect-single',!b);this.options.multiple=b;this.element[0].multiple=b;this.refresh();break;case'position':this.position()}$.Widget.prototype._setOption.apply(this,arguments)}})})(jQuery);